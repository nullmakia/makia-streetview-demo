<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Step1 Mic Permission Only</title>
<style>
  html,body{height:100%;margin:0;font:16px/1.5 system-ui,-apple-system,"Segoe UI",sans-serif}
  main{min-height:100%;display:grid;place-items:center;padding:24px}
  .card{max-width:640px;width:100%;border:1px solid #ddd;border-radius:14px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.06);background:#fff}
  button{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
  pre{background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:10px;white-space:pre-wrap}
  code{background:#f2f2f2;padding:2px 4px;border-radius:6px}
</style>
<main>
  <div class="card">
    <h1>🎤 Step1: マイク許可テスト</h1>
    <p>ボタンを押すと <code>getUserMedia({audio:true})</code> を<strong>1回だけ</strong>実行し、許可後は即停止します。</p>
    <p><button id="btn">🎤 マイク権限をリクエスト</button></p>
    <pre id="log">準備完了</pre>
    <ul>
      <li>HTTPS 必須（GitHub Pages はOK）</li>
      <li>もしダイアログが出ない → ブラウザの「サイトの設定」でこのドメインのマイクがブロックになっていないか確認</li>
    </ul>
  </div>
</main>
<script>
const logEl = document.getElementById("log");
const log = (m) => logEl.textContent = m;

document.getElementById("btn").addEventListener("click", async () => {
  if (!navigator.mediaDevices?.getUserMedia) return log("未対応：getUserMedia");
  if (!isSecureContext) return log("HTTPSで開いてください（isSecureContext=false）");

  log("マイク権限をリクエスト中…");
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach(t => t.stop());

    // Permission API（対応ブラウザのみ）
    let state = "unknown";
    try {
      const p = await navigator.permissions.query({ name:"microphone" });
      state = p.state;
    } catch {}
    log(`✅ 許可されました（permissions.state=${state}）`);
  } catch (e) {
    const n = e?.name || "Error";
    const msg =
      n === "NotAllowedError" ? "❌ 拒否/ブロック（サイト設定で『マイク: 許可』へ）" :
      n === "NotFoundError"    ? "❌ マイク未接続/無効" :
      n === "NotReadableError" ? "❌ 別アプリがマイク占有中" :
      `❌ 失敗: ${n}`;
    log(msg);
  }
});
</script>
</html>
