<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mic Permission Minimal</title>
<style>
  :root { color-scheme: light dark; }
  html,body { height:100%; margin:0; font:16px/1.5 system-ui, -apple-system, "Segoe UI", sans-serif; }
  main { min-height:100%; display:grid; place-items:center; padding:24px; }
  .card { max-width:560px; width:100%; border:1px solid #ddd; border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.06); background:#fff; }
  button { padding:10px 14px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; cursor:pointer; }
  pre { background:#f7f7f7; border:1px solid #eee; border-radius:10px; padding:10px; overflow:auto; white-space:pre-wrap; }
</style>
<main>
  <div class="card">
    <h1>ğŸ¤ ãƒã‚¤ã‚¯è¨±å¯ãƒ†ã‚¹ãƒˆï¼ˆæœ€å°æ§‹æˆï¼‰</h1>
    <p>ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ <code>getUserMedia({audio:true})</code> ã‚’<strong>1å›ã ã‘</strong>å®Ÿè¡Œã—ã€è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚è¨±å¯å¾Œã¯å³åœæ­¢ã—ã¾ã™ã€‚</p>
    <p>
      <button id="btn">ğŸ¤ ãƒã‚¤ã‚¯æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
    </p>
    <pre id="log" aria-live="polite">æº–å‚™å®Œäº†</pre>
    <small>
      æ¡ä»¶: HTTPS / ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå†…å®Ÿè¡Œã€‚GitHub Pages ã¯ OKã€‚<br>
      ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºãªã„å ´åˆ: ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚µã‚¤ãƒˆè¨­å®šã§ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã€Œãƒã‚¤ã‚¯ã€ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã€å†èª­è¾¼ã€‚
    </small>
  </div>
</main>

<script>
const logEl = document.getElementById("log");
const log = (...a) => logEl.textContent = a.join(" ");

document.getElementById("btn").addEventListener("click", async () => {
  if (!navigator.mediaDevices?.getUserMedia) {
    log("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ getUserMedia ã«æœªå¯¾å¿œã§ã™ã€‚");
    return;
  }
  if (!window.isSecureContext) {
    log("HTTPS ã§ãªã„ãŸã‚ãƒã‚¤ã‚¯è¨±å¯ã¯å‡ºã¾ã›ã‚“ã€‚https:// ã§é–‹ã„ã¦ãã ã•ã„ã€‚");
    return;
  }

  log("ãƒã‚¤ã‚¯æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­â€¦");
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // ã“ã“ã¾ã§æ¥ãŸã‚‰ã€Œè¨±å¯ã€æ¸ˆã¿ã€‚ä»Šå›ã¯ç–é€šç¢ºèªã ã‘ãªã®ã§å³åœæ­¢ã€‚
    for (const t of stream.getTracks()) t.stop();

    // å¯èƒ½ãªã‚‰ Permission çŠ¶æ…‹ã‚‚è¡¨ç¤ºï¼ˆæœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã¯ç„¡è¦–ï¼‰
    if (navigator.permissions?.query) {
      try {
        const st = await navigator.permissions.query({ name: "microphone" });
        log(`âœ… è¨±å¯ã•ã‚Œã¾ã—ãŸï¼ˆstate: ${st.state}ï¼‰`);
      } catch {
        log("âœ… è¨±å¯ã•ã‚Œã¾ã—ãŸ");
      }
    } else {
      log("âœ… è¨±å¯ã•ã‚Œã¾ã—ãŸ");
    }
  } catch (e) {
    // ä»£è¡¨çš„ãªã‚¨ãƒ©ãƒ¼ã®æ–‡è¨€ã‚’åˆ†ã‹ã‚Šã‚„ã™ã
    const n = e?.name || "Error";
    const msg =
      n === "NotAllowedError" ? "âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‹’å¦/ã‚µã‚¤ãƒˆãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚" :
      n === "NotFoundError"  ? "âŒ ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚" :
      n === "NotReadableError" ? "âŒ ä»–ã‚¢ãƒ—ãƒªãŒãƒã‚¤ã‚¯ã‚’å æœ‰ä¸­ã®å¯èƒ½æ€§ã€‚" :
      `âŒ å¤±æ•—: ${n}`;
    log(msg);
  }
});
</script>
</html>
