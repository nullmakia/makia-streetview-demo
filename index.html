<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Step3 MediaRecorder â†’ STT(ä»»æ„)</title>
<style>
  html,body{height:100%;margin:0;font:16px/1.5 system-ui,-apple-system,"Segoe UI",sans-serif}
  main{min-height:100%;display:grid;place-items:center;padding:24px}
  .card{max-width:760px;width:100%;border:1px solid #ddd;border-radius:14px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.06);background:#fff}
  button{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  pre{background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:10px;white-space:pre-wrap;min-height:2.5em}
  .meter{height:8px;background:#eee;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%}
</style>
<main>
  <div class="card">
    <h1>ğŸ¤ Step3: MediaRecorder ã§éŒ²éŸ³ â†’ï¼ˆä»»æ„ï¼‰STT</h1>
    <div class="row">
      <button id="start">éŒ²éŸ³é–‹å§‹</button>
      <button id="stop" disabled>â–  åœæ­¢</button>
      <button id="clear">è¡¨ç¤ºã‚¯ãƒªã‚¢</button>
    </div>
    <p>å…¥åŠ›ãƒ¬ãƒ™ãƒ«:</p>
    <div class="meter"><div id="bar" class="bar"></div></div>

    <h3>çµæœ</h3>
    <p>éŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«:</p>
    <div id="audioBox">ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>

    <p>STTãƒ†ã‚­ã‚¹ãƒˆï¼ˆä»»æ„ãƒ»STT_ENDPOINTè¨­å®šæ™‚ï¼‰:</p>
    <pre id="text"></pre>

    <p>ãƒ­ã‚°:</p>
    <pre id="log">æº–å‚™å®Œäº†</pre>

    <small>
      â€¢ ã¾ãšä¿å­˜ãƒ»å†ç”Ÿã¾ã§ç¢ºèª â†’ OKãªã‚‰ <code>STT_ENDPOINT</code> ã‚’ã‚ãªãŸã®Workerç­‰ã«å·®ã—æ›¿ãˆã€‚<br>
      â€¢ iOS/Safari ã¯ <code>audio/mp4</code> ç³»ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
      â€¢ åŸ‹ã‚è¾¼ã¿è¡¨ç¤ºã§ä½¿ã†å ´åˆã¯ <code>&lt;iframe allow="microphone"&gt;</code> ãŒå¿…è¦ã€‚
    </small>
  </div>
</main>

<script>
const $  = (id)=>document.getElementById(id);
const log= (m)=>{$("log").textContent = String(m)}

const STT_ENDPOINT = ""; // ä¾‹: "https://xxxxx.workers.dev/stt"ï¼ˆç©ºã®ã¾ã¾ã§ã‚‚OKï¼‰

let stream=null, rec=null, chunks=[], analyser=null, raf=0;

// ä½¿ãˆã‚‹ MIME ã‚’é¸ã¶ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ä»»ã›ã‚‹å®‰å…¨ç­–ï¼‰
function pickAudioMime(){
  const cands=[
    "audio/webm;codecs=opus",
    "audio/webm",
    "audio/mp4;codecs=mp4a.40.2",
    "audio/mp4"
  ];
  if (!window.MediaRecorder?.isTypeSupported) return "";
  for (const t of cands) if (MediaRecorder.isTypeSupported(t)) return t;
  return "";
}

async function preflight(){
  const s = await navigator.mediaDevices.getUserMedia({audio:true});
  s.getTracks().forEach(t=>t.stop());
}

function startLevelMeter(stream){
  const ac = new (window.AudioContext||window.webkitAudioContext)();
  const src = ac.createMediaStreamSource(stream);
  analyser = ac.createAnalyser();
  analyser.fftSize = 1024;
  src.connect(analyser);

  const data = new Uint8Array(analyser.frequencyBinCount);
  const bar  = $("bar");
  function tick(){
    analyser.getByteTimeDomainData(data);
    // æ³¢å½¢ã®æŒ¯å¹…ã‹ã‚‰ã–ã£ãã‚Šãƒ¬ãƒ™ãƒ«ç®—å‡º
    let sum=0;
    for (let i=0;i<data.length;i++){
      const v = (data[i]-128)/128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum/data.length); // 0..1
    bar.style.width = Math.min(100, Math.round(rms*180)) + "%";
    raf = requestAnimationFrame(tick);
  }
  tick();
  return ()=>{ cancelAnimationFrame(raf); ac.close(); };
}

function attachAudio(blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("audio");
  a.controls = true;
  a.src = url;

  const dl = document.createElement("a");
  dl.textContent = "ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
  dl.href = url;
  const ext = (blob.type.includes("mp4")?"m4a":(blob.type.includes("webm")?"webm":"bin"));
  dl.download = "recording."+ext;

  const box = $("audioBox");
  box.innerHTML = "";
  box.append(a," ",dl);
}

async function maybeSendToSTT(blob){
  if (!STT_ENDPOINT){ log("STTæœªè¨­å®šï¼ˆéŒ²éŸ³ã¯æˆåŠŸï¼‰"); return; }
  log("STTé€ä¿¡ä¸­â€¦");
  try{
    const res = await fetch(STT_ENDPOINT,{
      method:"POST",
      headers:{ "Content-Type": blob.type || "application/octet-stream" },
      body: await blob.arrayBuffer()
    });
    if (!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json().catch(()=>null);
    const text = j?.text ?? j?.result ?? "";
    $("text").textContent = text || "(ç©º)";
    log("STTå®Œäº†");
  }catch(e){
    log("STTå¤±æ•—: "+ (e?.message||e));
  }
}

$("start").addEventListener("click", async ()=>{
  $("text").textContent = "";
  $("audioBox").textContent = "éŒ²éŸ³ä¸­â€¦";
  $("stop").disabled = true;

  if (!isSecureContext) return log("HTTPSã§é–‹ã„ã¦ãã ã•ã„ï¼ˆisSecureContext=falseï¼‰");
  if (!navigator.mediaDevices?.getUserMedia) return log("æœªå¯¾å¿œï¼šgetUserMedia");
  if (!window.MediaRecorder) return log("æœªå¯¾å¿œï¼šMediaRecorder");

  try{
    log("æ¨©é™ã‚’å–å¾—ä¸­â€¦");
    await preflight(); // è¨±å¯
