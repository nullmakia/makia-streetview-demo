<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Step2 SpeechRecognition Only</title>
<style>
  html,body{height:100%;margin:0;font:16px/1.5 system-ui,-apple-system,"Segoe UI",sans-serif}
  main{min-height:100%;display:grid;place-items:center;padding:24px}
  .card{max-width:700px;width:100%;border:1px solid #ddd;border-radius:14px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.06);background:#fff}
  button{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
  pre{background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:10px;white-space:pre-wrap;min-height:2.5em}
  .row{display:flex;gap:8px;flex-wrap:wrap}
</style>
<main>
  <div class="card">
    <h1>ğŸ¤ Step2: è¨±å¯å¾Œã« Web Speech API ã ã‘è©¦ã™</h1>
    <div class="row">
      <button id="start">â‘  æ¨©é™ã‚’å–ã£ã¦ã‹ã‚‰é–‹å§‹</button>
      <button id="stop" disabled>â–  åœæ­¢</button>
    </div>
    <p>çµæœ:</p>
    <pre id="log">æº–å‚™å®Œäº†</pre>
    <p>æœ€çµ‚ãƒ†ã‚­ã‚¹ãƒˆ:</p>
    <pre id="text"></pre>
    <small>å¯¾å¿œ: Chrome/Edgeï¼ˆPC/Androidï¼‰ã€‚iOSç³»(WKWebViewç³»å«ã‚€)ã¯ <code>SpeechRecognition</code> ãŒä¸å®‰å®š/æœªå®Ÿè£…ã®ã“ã¨ãŒå¤šã„ã€‚</small>
  </div>
</main>
<script>
const $ = (id) => document.getElementById(id);
const log = (m) => $("log").textContent = m;

async function preflightMicPermission() {
  const s = await navigator.mediaDevices.getUserMedia({ audio:true });
  s.getTracks().forEach(t => t.stop());
}

let recog = null, running = false;

$("start").addEventListener("click", async () => {
  $("text").textContent = "";
  if (!isSecureContext) return log("HTTPSã§é–‹ã„ã¦ãã ã•ã„ï¼ˆisSecureContext=falseï¼‰");
  if (!navigator.mediaDevices?.getUserMedia) return log("æœªå¯¾å¿œï¼šgetUserMedia");
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return log("æœªå¯¾å¿œï¼šSpeechRecognition");

  try {
    log("â‘  ãƒã‚¤ã‚¯æ¨©é™ã‚’å–å¾—ä¸­â€¦");
    await preflightMicPermission(); // â† ã“ã“ã§å¿…ãšè¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  } catch (e) {
    return log("æ¨©é™å–å¾—ã«å¤±æ•—: " + (e?.name || e));
  }

  log("â‘¡ éŸ³å£°èªè­˜ã‚’é–‹å§‹â€¦");
  try {
    const r = new SR();
    recog = r;
    r.lang = "ja-JP";
    r.continuous = true;
    r.interimResults = false;
    r.maxAlternatives = 1;

    r.onstart = () => { running = true; log("èªè­˜ onstart"); $("stop").disabled = false; };
    r.onaudiostart = () => log("èªè­˜ onaudiostart");
    r.onsoundstart = () => log("èªè­˜ onsoundstart");
    r.onspeechstart= () => log("èªè­˜ onspeechstart");
    r.onspeechend  = () => log("èªè­˜ onspeechend");
    r.onsoundend   = () => log("èªè­˜ onsoundend");
    r.onaudioend   = () => log("èªè­˜ onaudioend");
    r.onend = () => { running = false; log("èªè­˜ onendï¼ˆè‡ªå‹•çµ‚äº†ï¼‰"); $("stop").disabled = true; };
    r.onerror = (e) => log("èªè­˜ onerror: " + e.error);

    r.onresult = (ev) => {
      let final = "";
      for (let i = ev.resultIndex; i < ev.results.length; i++) {
        if (ev.results[i].isFinal) final += ev.results[i][0].transcript;
      }
      if (final) $("text").textContent += (final + "\n");
    };

    r.start(); // ã“ã“ã§å¤±æ•—ã™ã‚‹ãªã‚‰ iOS/WKWebView ã®å¯èƒ½æ€§é«˜
  } catch (e) {
    log("startä¾‹å¤–: " + (e?.name || e));
  }
});

$("stop").addEventListener("click", () => {
  try { recog && recog.stop && recog.stop(); } catch {}
  $("stop").disabled = true;
  log("åœæ­¢æŒ‡ç¤º");
});
</script>
</html>
