<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mic Permission Minimal</title>
<style>
  :root { color-scheme: light dark; }
  html,body { height:100%; margin:0; font:16px/1.5 system-ui, -apple-system, "Segoe UI", sans-serif; }
  main { min-height:100%; display:grid; place-items:center; padding:24px; }
  .card { max-width:560px; width:100%; border:1px solid #ddd; border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.06); background:#fff; }
  button { padding:10px 14px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; cursor:pointer; }
  pre { background:#f7f7f7; border:1px solid #eee; border-radius:10px; padding:10px; overflow:auto; white-space:pre-wrap; }
</style>
<main>
  <div class="card">
    <h1>🎤 マイク許可テスト（最小構成）</h1>
    <p>このボタンを押すと <code>getUserMedia({audio:true})</code> を<strong>1回だけ</strong>実行し、許可ダイアログを表示します。許可後は即停止します。</p>
    <p>
      <button id="btn">🎤 マイク権限をリクエスト</button>
    </p>
    <pre id="log" aria-live="polite">準備完了</pre>
    <small>
      条件: HTTPS / ユーザー操作内実行。GitHub Pages は OK。<br>
      ダイアログが出ない場合: ブラウザのサイト設定でこのドメインの「マイク」がブロックされていないか確認し、再読込。
    </small>
  </div>
</main>

<script>
const logEl = document.getElementById("log");
const log = (...a) => logEl.textContent = a.join(" ");

document.getElementById("btn").addEventListener("click", async () => {
  if (!navigator.mediaDevices?.getUserMedia) {
    log("このブラウザは getUserMedia に未対応です。");
    return;
  }
  if (!window.isSecureContext) {
    log("HTTPS でないためマイク許可は出ません。https:// で開いてください。");
    return;
  }

  log("マイク権限をリクエスト中…");
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // ここまで来たら「許可」済み。今回は疎通確認だけなので即停止。
    for (const t of stream.getTracks()) t.stop();

    // 可能なら Permission 状態も表示（未対応ブラウザは無視）
    if (navigator.permissions?.query) {
      try {
        const st = await navigator.permissions.query({ name: "microphone" });
        log(`✅ 許可されました（state: ${st.state}）`);
      } catch {
        log("✅ 許可されました");
      }
    } else {
      log("✅ 許可されました");
    }
  } catch (e) {
    // 代表的なエラーの文言を分かりやすく
    const n = e?.name || "Error";
    const msg =
      n === "NotAllowedError" ? "❌ ユーザーが拒否/サイトがブロックされています。" :
      n === "NotFoundError"  ? "❌ マイクデバイスが見つかりません。" :
      n === "NotReadableError" ? "❌ 他アプリがマイクを占有中の可能性。" :
      `❌ 失敗: ${n}`;
    log(msg);
  }
});
</script>
</html>
