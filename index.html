<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Street View × GPS × キャラ反応</title>

<style>
  html, body, #pano { height: 100%; margin: 0; background: #000; }
  #pano {
    position: fixed;
    inset: 0;
    z-index: 0;            /* 背景として最背面に固定 */
  }
  /* —— キャラ（前景） —— */
  .sprite {
    position: fixed;
    z-index: 2000;         /* パノラマより十分手前に */
    pointer-events: auto;
    touch-action: manipulation;
    image-rendering: auto;
    filter: drop-shadow(0 8px 14px rgba(0,0,0,.35));
    will-change: transform;
    user-select: none;
  }
  /* 少年（左寄り・下） */
  .boy {
    left: 12vw; bottom: 10vh;
    width: min(40vw, 320px);
    aspect-ratio: 5/6;
    background: url('fool1.png') center / contain no-repeat;
  }
  /* 犬（右下寄り・小さめ） */
  .dog {
    right: 10vw; bottom: 8vh;
    width: min(26vw, 220px);
    aspect-ratio: 5/6;
    background: url('fool2.png') center / contain no-repeat;
  }

  /* 影（簡易） */
  .shadow { z-index: 1500; } /* 影はキャラより背面だがパノラマより前 */

  /* 反応アニメ（少年：ぴょん＋手を振る風の揺れ） */
  @keyframes boyJump {
    0%   { transform: translateY(0) rotate(0deg) }
    20%  { transform: translateY(-14px) rotate(-2deg) }
    40%  { transform: translateY(-22px) rotate(2deg) }
    60%  { transform: translateY(-10px) rotate(-1deg) }
    100% { transform: translateY(0) rotate(0deg) }
  }
  .boy.react { animation: boyJump .7s ease-out; }

  /* 反応アニメ（犬：首ぶんぶん＋小ジャンプ） */
  @keyframes dogShake {
    0% { transform: translateY(0) rotate(0deg) }
    15% { transform: translateY(-6px) rotate(-6deg) }
    30% { transform: translateY(-6px) rotate(6deg) }
    45% { transform: translateY(-6px) rotate(-6deg) }
    60% { transform: translateY(-2px) rotate(4deg) }
    100%{ transform: translateY(0) rotate(0deg) }
  }
  .dog.react { animation: dogShake .6s ease-out; }

  /* セリフふきだし */
  .bubble {
    position: absolute; left: 50%; bottom: 100%;
    transform: translateX(-50%);
    white-space: nowrap;
    background: rgba(255,255,255,.95);
    color: #222; font: 600 14px/1.2 system-ui, -apple-system, "Segoe UI", sans-serif;
    padding: 8px 10px; border-radius: 14px;
    border: 1px solid rgba(0,0,0,.15);
    box-shadow: 0 6px 12px rgba(0,0,0,.18);
    opacity: 0; animation: pop .75s ease forwards;
    z-index: 20;
  }
  @keyframes pop {
    0% { transform: translate(-50%, 6px) scale(.9); opacity: 0; }
    40%{ transform: translate(-50%, 0)   scale(1);   opacity: 1; }
    90%{ opacity: 1; }
    100%{ opacity: 0; }
  }

  /* HUD最小限 */
  .hud    { z-index: 3000; } /* HUDは一番前 */
  .hud button { padding: 6px 8px; border: 0; border-radius: 8px; }
</style>

<body>
  <div id="pano" aria-label="Street View 背景"></div>

  <!-- 前景キャラ -->
  <div class="sprite boy" id="boy"></div>
  <div class="sprite dog" id="dog"></div>
  <div class="shadow" aria-hidden="true"></div>

  <!-- 状態表示 / iOSモーション許可 -->
  <div class="hud">
    <div>状態: <span id="st">初期化中…</span></div>
    <div>速度: <span id="spd">0.0</span> m/s　方位: <span id="hdg">—</span>°</div>
    <div style="margin-top:6px">
      <button id="btnMotion">モーション許可（iOS）</button>
    </div>
  </div>

<script>
let pano, sv;
let lastPanoId = null;

// ★ 角度ユーティリティ
const toRad = d => d * Math.PI / 180;
const toDeg = r => r * 180 / Math.PI;
const norm360 = a => (a % 360 + 360) % 360;
const shortestDeltaDeg = (a,b) => {
  let d = norm360(b) - norm360(a);
  if (d > 180) d -= 360;
  if (d < -180) d += 360;
  return d;
};

// ★ 2点間の進行方位（初期方位, bearing）
function bearing(lat1, lng1, lat2, lng2) {
  const φ1 = toRad(lat1), φ2 = toRad(lat2), Δλ = toRad(lng2 - lng1);
  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.cos(φ2) + Math.sin(φ1)*Math.sin(φ2)*Math.cos(Δλ);
  return norm360(toDeg(Math.atan2(y, x)));
}

// ★ スムージング（指数移動平均）
function smoothAngle(prev, next, alpha = 0.25) {
  if (prev == null) return next;
  const delta = shortestDeltaDeg(prev, next);
  return norm360(prev + alpha * delta);
}

function init() {
  sv = new google.maps.StreetViewService();
  pano = new google.maps.StreetViewPanorama(document.getElementById('pano'), {
    addressControl: false,
    fullscreenControl: false,
    motionTracking: false,
    disableDefaultUI: true,
    visible: true
  });

  const st  = document.getElementById('st');
  const spd = document.getElementById('spd');
  const hdgEl = document.getElementById('hdg');

  // ★ 進行方向・位置を保持
  let lastPos = null;            // {lat, lng}
  let smoothedHeading = null;    // 平滑化済み方位（度）

  // ★ 進行方向にPovを向ける
  function setHeadingTo(headingDeg) {
    const pov = pano.getPov();
    // 小さな揺れは無視（5〜8度くらい）
    const delta = Math.abs(shortestDeltaDeg(pov.heading ?? 0, headingDeg));
    if (delta < 6) return;
    pano.setPov({ heading: headingDeg, pitch: pov.pitch ?? 0, zoom: 1 });
  }

  // ★ パノラマを「前進方向のリンク」に沿って切替
  function maybeFollowForwardLink(panoData, desiredHeading) {
    if (!panoData?.links?.length) return false;
    // 進行方向に最も近いリンクを選択
    let best = null, bestDiff = 999;
    panoData.links.forEach(l => {
      const diff = Math.abs(shortestDeltaDeg(desiredHeading, l.heading));
      if (diff < bestDiff) { bestDiff = diff; best = l; }
    });
    // 進行方向に近いリンクがあれば、その先へ
    if (best && bestDiff <= 45 && best.pano) {
      if (best.pano !== lastPanoId) {
        pano.setPano(best.pano);
        lastPanoId = best.pano;
        // 先でも視線を進行方向へ
        setHeadingTo(desiredHeading);
        return true;
      }
    }
    return false;
  }

  if ('geolocation' in navigator) {
    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude, accuracy, speed, heading } = pos.coords;
      spd.textContent = (speed || 0).toFixed(1);
      st.textContent = `測位OK（±${Math.round(accuracy||0)}m）`;

      const here = { lat: latitude, lng: longitude };

      // ★ 進行方向の決定
      let course = null;
      if (typeof heading === 'number' && heading >= 0 && (speed || 0) >= 3) {
        // GPSのコース（速度が出ている時だけ信頼）
        course = heading;
      } else if (lastPos && (here.lat !== lastPos.lat || here.lng !== lastPos.lng)) {
        // 自前のベアリング
        course = bearing(lastPos.lat, lastPos.lng, here.lat, here.lng);
      }
      if (course != null) {
        smoothedHeading = smoothAngle(smoothedHeading, course, 0.35);
        hdgEl.textContent = smoothedHeading.toFixed(0);
        setHeadingTo(smoothedHeading);
      }

      // ★ 近傍パノラマの取得（半径はやや広め）
      sv.getPanorama({ location: here, radius: 100 }, (data, status) => {
        if (status === 'OK' && data?.location) {
          const panoId = data.location.pano;
          if (panoId !== lastPanoId) {
            // まず最寄りにジャンプ
            pano.setPano(panoId);
            lastPanoId = panoId;
          }
          // 常に視線を進行方向へ
          if (smoothedHeading != null) {
            setHeadingTo(smoothedHeading);
            // 車移動時：可能なら前方リンクへ進める
            if ((speed || 0) >= 4) {
              maybeFollowForwardLink(data, smoothedHeading);
            }
          }
        } else {
          st.textContent = '近傍パノラマが見つかりません';
        }
      });

      lastPos = here;
    }, err => {
      st.textContent = `測位エラー: ${err.message}`;
    }, { enableHighAccuracy: true, maximumAge: 1000, timeout: 15000 });
  } else {
    st.textContent = 'Geolocation未対応';
  }

  // —— 端末コンパスのフォールバック（停止中や低速時のみ使う想定） —— //
  function onOri(e) {
    let heading = (typeof e.webkitCompassHeading === 'number')
      ? e.webkitCompassHeading
      : (e.absolute && typeof e.alpha === 'number') ? 360 - e.alpha : null;
    if (heading != null) {
      // 低速時のみコンパスで補助（車内の磁気誤差を考慮）
      if (!spd.textContent || parseFloat(spd.textContent) < 2.0) {
        smoothedHeading = smoothAngle(smoothedHeading, heading, 0.25);
        hdgEl.textContent = smoothedHeading.toFixed(0);
        setHeadingTo(smoothedHeading);
      }
    }
  }
  document.getElementById('btnMotion').addEventListener('click', () => {
    const C = window.DeviceOrientationEvent;
    if (C && typeof C.requestPermission === 'function') {
      C.requestPermission().then(state => {
        if (state === 'granted') addEventListener('deviceorientation', onOri, true);
      }).catch(()=>{});
    } else {
      addEventListener('deviceorientation', onOri, true);
    }
  });

  // —— 既存のキャラ反応処理はそのまま —— //
  const boy = document.getElementById('boy');
  const dog = document.getElementById('dog');
  function bounce(el, cls) {
    el.classList.remove(cls); void el.offsetWidth; el.classList.add(cls);
    el.addEventListener('animationend', () => el.classList.remove(cls), { once: true });
  }
  function bubble(el, text) {
    const b = document.createElement('div');
    b.className = 'bubble'; b.textContent = text; el.appendChild(b);
    setTimeout(() => b.remove(), 800);
  }
  boy.addEventListener('click',  () => { bounce(boy, 'react'); bubble(boy, 'いこう！'); });
  boy.addEventListener('touchend', (e) => { e.preventDefault(); bounce(boy, 'react'); bubble(boy, 'いこう！'); }, { passive:false });
  dog.addEventListener('click',  () => { bounce(dog, 'react'); bubble(dog, 'ワン！'); });
  dog.addEventListener('touchend', (e) => { e.preventDefault(); bounce(dog, 'react'); bubble(dog, 'ワン！'); }, { passive:false });
}
</script>

<!-- ★YOUR_API_KEY をあなたのキーに置き換え -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQQHZONAJ27HZwG20IJbRYZXZ6ADxbtP0&callback=init&v=weekly"></script>
</body>
</html>
