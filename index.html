<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Step3 MediaRecorder → STT(任意)</title>
<style>
  html,body{height:100%;margin:0;font:16px/1.5 system-ui,-apple-system,"Segoe UI",sans-serif}
  main{min-height:100%;display:grid;place-items:center;padding:24px}
  .card{max-width:760px;width:100%;border:1px solid #ddd;border-radius:14px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.06);background:#fff}
  button{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  pre{background:#f7f7f7;border:1px solid #eee;border-radius:10px;padding:10px;white-space:pre-wrap;min-height:2.5em}
  .meter{height:8px;background:#eee;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%}
</style>
<main>
  <div class="card">
    <h1>🎤 Step3: MediaRecorder で録音 →（任意）STT</h1>
    <div class="row">
      <button id="start">録音開始</button>
      <button id="stop" disabled>■ 停止</button>
      <button id="clear">表示クリア</button>
    </div>
    <p>入力レベル:</p>
    <div class="meter"><div id="bar" class="bar"></div></div>

    <h3>結果</h3>
    <p>録音ファイル:</p>
    <div id="audioBox">（まだありません）</div>

    <p>STTテキスト（任意・STT_ENDPOINT設定時）:</p>
    <pre id="text"></pre>

    <p>ログ:</p>
    <pre id="log">準備完了</pre>

    <small>
      • まず保存・再生まで確認 → OKなら <code>STT_ENDPOINT</code> をあなたのWorker等に差し替え。<br>
      • iOS/Safari は <code>audio/mp4</code> 系になることがあります。<br>
      • 埋め込み表示で使う場合は <code>&lt;iframe allow="microphone"&gt;</code> が必要。
    </small>
  </div>
</main>

<script>
const $  = (id)=>document.getElementById(id);
const log= (m)=>{$("log").textContent = String(m)}

const STT_ENDPOINT = ""; // 例: "https://xxxxx.workers.dev/stt"（空のままでもOK）

let stream=null, rec=null, chunks=[], analyser=null, raf=0;

// 使える MIME を選ぶ（ブラウザに任せる安全策）
function pickAudioMime(){
  const cands=[
    "audio/webm;codecs=opus",
    "audio/webm",
    "audio/mp4;codecs=mp4a.40.2",
    "audio/mp4"
  ];
  if (!window.MediaRecorder?.isTypeSupported) return "";
  for (const t of cands) if (MediaRecorder.isTypeSupported(t)) return t;
  return "";
}

async function preflight(){
  const s = await navigator.mediaDevices.getUserMedia({audio:true});
  s.getTracks().forEach(t=>t.stop());
}

function startLevelMeter(stream){
  const ac = new (window.AudioContext||window.webkitAudioContext)();
  const src = ac.createMediaStreamSource(stream);
  analyser = ac.createAnalyser();
  analyser.fftSize = 1024;
  src.connect(analyser);

  const data = new Uint8Array(analyser.frequencyBinCount);
  const bar  = $("bar");
  function tick(){
    analyser.getByteTimeDomainData(data);
    // 波形の振幅からざっくりレベル算出
    let sum=0;
    for (let i=0;i<data.length;i++){
      const v = (data[i]-128)/128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum/data.length); // 0..1
    bar.style.width = Math.min(100, Math.round(rms*180)) + "%";
    raf = requestAnimationFrame(tick);
  }
  tick();
  return ()=>{ cancelAnimationFrame(raf); ac.close(); };
}

function attachAudio(blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("audio");
  a.controls = true;
  a.src = url;

  const dl = document.createElement("a");
  dl.textContent = "📥 ダウンロード";
  dl.href = url;
  const ext = (blob.type.includes("mp4")?"m4a":(blob.type.includes("webm")?"webm":"bin"));
  dl.download = "recording."+ext;

  const box = $("audioBox");
  box.innerHTML = "";
  box.append(a," ",dl);
}

async function maybeSendToSTT(blob){
  if (!STT_ENDPOINT){ log("STT未設定（録音は成功）"); return; }
  log("STT送信中…");
  try{
    const res = await fetch(STT_ENDPOINT,{
      method:"POST",
      headers:{ "Content-Type": blob.type || "application/octet-stream" },
      body: await blob.arrayBuffer()
    });
    if (!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json().catch(()=>null);
    const text = j?.text ?? j?.result ?? "";
    $("text").textContent = text || "(空)";
    log("STT完了");
  }catch(e){
    log("STT失敗: "+ (e?.message||e));
  }
}

$("start").addEventListener("click", async ()=>{
  $("text").textContent = "";
  $("audioBox").textContent = "録音中…";
  $("stop").disabled = true;

  if (!isSecureContext) return log("HTTPSで開いてください（isSecureContext=false）");
  if (!navigator.mediaDevices?.getUserMedia) return log("未対応：getUserMedia");
  if (!window.MediaRecorder) return log("未対応：MediaRecorder");

  try{
    log("権限を取得中…");
    await preflight(); // 許可
