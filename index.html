<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Street View Ã— ã‚­ãƒ£ãƒ© Ã— éŸ³å£°ä¼šè©±ï¼ˆStep3çµ±åˆï¼‰</title>

<style>
  html, body, #pano { height: 100%; margin: 0; background: #000; }
  #pano { position: fixed; inset: 0; z-index: 0; }

  /* â€”â€” ã‚­ãƒ£ãƒ©ï¼ˆå‰æ™¯ï¼‰ â€”â€” */
  .sprite { position: fixed; z-index: 2000; pointer-events: auto; touch-action: manipulation;
    filter: drop-shadow(0 8px 14px rgba(0,0,0,.35)); user-select: none; }
  .boy { left: 12vw; bottom: 10vh; width: min(40vw, 320px); aspect-ratio: 5/6;
    background: url('fool1.png') center / contain no-repeat; }
  .dog { left: calc(6vw + min(20vw, 100px) + 15vw); bottom: 11vh; width: min(15vw, 200px); aspect-ratio: 5/6;
    background: url('fool2.png') center / contain no-repeat; }

  @keyframes boyJump { 0%{transform:translateY(0) rotate(0)}20%{transform:translateY(-14px) rotate(-2deg)}40%{transform:translateY(-22px) rotate(2deg)}60%{transform:translateY(-10px) rotate(-1deg)}100%{transform:translateY(0) rotate(0)} }
  .boy.react { animation: boyJump .7s ease-out; }
  @keyframes dogShake { 0%{transform:translateY(0) rotate(0)}15%{transform:translateY(-6px) rotate(-6deg)}30%{transform:translateY(-6px) rotate(6deg)}45%{transform:translateY(-6px) rotate(-6deg)}60%{transform:translateY(-2px) rotate(4deg)}100%{transform:translateY(0) rotate(0)} }
  .dog.react { animation: dogShake .6s ease-out; }

  .bubble{ position:absolute; left:50%; bottom:100%; transform:translateX(-50%); white-space:nowrap;
    background:rgba(255,255,255,.95); color:#222; font:600 14px/1.2 system-ui,-apple-system,"Segoe UI",sans-serif;
    padding:8px 10px; border-radius:14px; border:1px solid rgba(0,0,0,.15); box-shadow:0 6px 12px rgba(0,0,0,.18);
    opacity:0; animation:pop .75s ease forwards; z-index: 20; }
  @keyframes pop { 0%{transform:translate(-50%,6px) scale(.9); opacity:0}40%{transform:translate(-50%,0) scale(1); opacity:1}90%{opacity:1}100%{opacity:0} }

  /* HUD / ãƒ†ãƒ­ãƒƒãƒ— / ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ */
  .hud { position: fixed; top: 12px; left: 12px; z-index: 3000; color: #fff; text-shadow:0 1px 3px rgba(0,0,0,.6) }
  #aiTelopBox{ position:fixed; left:12px; right:12px; bottom:12px; padding:10px 12px; background:rgba(255,255,255,.92);
    border:1px solid #e5e5e5; border-radius:12px; backdrop-filter:blur(4px); box-shadow:0 4px 18px rgba(0,0,0,.12);
    z-index:4000; font-size:14px; }
  #stopBtn{ position:fixed; right:12px; bottom:80px; z-index:4001; padding:10px 12px; border:1px solid #111;
    background:#444; color:#fff; border-radius:10px; }

  .meter{ display: none; }
  .bar{ height:100%; width:0% }
  .hidden { display: none !important; }
</style>

<body>
  <div id="pano" aria-label="Street View èƒŒæ™¯"></div>

  <!-- å‰æ™¯ã‚­ãƒ£ãƒ© -->
  <div class="sprite boy" id="boy"></div>
  <div class="sprite dog" id="dog"></div>

  <!-- HUD -->
  <div class="hud">
    <div>çŠ¶æ…‹: <span id="st">åˆæœŸåŒ–ä¸­â€¦</span></div>
    <div>é€Ÿåº¦: <span id="spd">0.0</span> m/sã€€æ–¹ä½: <span id="hdg">â€”</span>Â°</div>
  </div>

  <video id="cam" autoplay playsinline muted
    style="position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; display:none; pointer-events:none;">
  </video>

  <!-- ãƒ†ãƒ­ãƒƒãƒ— / ãƒã‚¤ã‚¯ -->
  <div id="aiTelopBox"><span id="aiTelop">ã‚¿ãƒƒãƒ—ã§é–‹å§‹</span></div>
  <button id="camBtn" style="position:fixed; right:12px; bottom:180px; z-index:4001; padding:10px 12px; border:1px solid #111; background:#07a; color:#fff; border-radius:10px;">
    ğŸ“· ã‚«ãƒ¡ãƒ©ON
  </button>
  <button id="gyroBtn" style="position:fixed; right:12px; bottom:142px; z-index:4001; padding:10px 12px; border:1px solid #111; background:#0a7; color:#fff; border-radius:10px;">
    ğŸ§­ æ–¹è§’è¿½å¾“ON
  </button>
  <button id="stopBtn" disabled>â–  åœæ­¢</button>
  <div class="meter"><div id="levelBar" class="bar"></div></div>

<script>
/***** è¨­å®šï¼ˆã‚ãªãŸã®Workerã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å·®ã—æ›¿ãˆï¼‰ *****/
const WORKER_BASE = "https://makia-animator.animator.workers.dev"; // ä¾‹
const STT_URL = WORKER_BASE + "/stt";        // éŸ³å£°â†’ãƒ†ã‚­ã‚¹ãƒˆï¼ˆStep3ã®ãƒãƒƒãƒï¼‰
const CHAT_URL = WORKER_BASE + "/chat";       // ãƒ†ã‚­ã‚¹ãƒˆâ†’ä¼šè©±å¿œç­”ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯ï¼‰

/***** ãƒ†ãƒ­ãƒƒãƒ— *****/
const telop = document.getElementById("aiTelop");
const stHud = document.getElementById("st");
function setStatus(t){ stHud.textContent = t; }          // â† çŠ¶æ…‹ã¯HUDã ã‘
function clearReply(){ telop.textContent = ''; }         // â† ä¼šè©±è¡¨ç¤ºã‚’æ¶ˆã™
function showReplyThinking(){ telop.textContent = 'â€¦è€ƒãˆä¸­'; } // â† ä¼šè©±å‰ã®ä¸€ç¬ã ã‘ä½¿ã†
function appendReplyChunk(s){ telop.textContent += s; }  // â† ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¿½åŠ 

const boy = document.getElementById('boy');
const dog = document.getElementById('dog');

/***** ã‚­ãƒ£ãƒ©ã®åå¿œ *****/
function bounce(el, cls){ el.classList.remove(cls); void el.offsetWidth; el.classList.add(cls);
  el.addEventListener('animationend', ()=> el.classList.remove(cls), { once:true }); }
function bubble(el, text){ const b=document.createElement('div'); b.className='bubble'; b.textContent=text; el.appendChild(b); setTimeout(()=> b.remove(), 800); }
  ['click','touchend'].forEach(type => {
    boy.addEventListener(type, async e=>{
      if(type==='touchend') e.preventDefault();
      bounce(boy,'react');
      bubble(boy,'ã„ã“ã†ï¼');
      if (window.rec?.state === 'recording') return;
  
      forceStopVisible = true;
      stopBtn.classList.remove('hidden');
      stopBtn.style.display = 'block';
  
      startRecording();
      setUIHidden(uiHidden);
    }, {passive:false});
  
    // â˜… çŠ¬ã‚¿ãƒƒãƒ—ã§UIã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    dog.addEventListener(type, e=>{
      if(type==='touchend') e.preventDefault();
      bounce(dog,'react');
      bubble(dog,'ãƒ¯ãƒ³ï¼');
      setUIHidden(!uiHidden);   // â† ã“ã‚Œã§ãƒˆã‚°ãƒ«
    }, {passive:false});
  });


/***** Street Viewï¼ˆæœ€å°èµ·å‹•ï¼‰ *****/
window.pano = null; window.sv = null;
const FALLBACK = { lat: 35.6595, lng: 139.7005 };
function showNearestPanorama(location, radius=150){
  window.sv.getPanorama({ location, radius }, (data, status) => {
    if (status === 'OK' && data?.location) {
      window.pano.setPano(data.location.pano);
     const el = document.getElementById('pano');
     if (el && el.style.display !== 'none') reflowStreetView();    }
  });
}
async function bootMaps(){
  await google.maps.importLibrary("maps");
  await google.maps.importLibrary("streetView");
  window.sv = new google.maps.StreetViewService();
  window.pano = new google.maps.StreetViewPanorama(document.getElementById('pano'),{
    addressControl:false,
    fullscreenControl:false,
    disableDefaultUI:true,
    visible:true,
    // iOS/Android ã®ã€Œç«¯æœ«ã®å‘ãã§å›ã™ã€ã‚’Mapså´ã«ä»»ã›ã‚‹ï¼ˆä»»ã›ãŸããªã„ãªã‚‰ trueâ†’false ã®ã¾ã¾ã§ã‚‚OKï¼‰
    motionTracking:true,
    motionTrackingControl:false
  });

  showNearestPanorama(FALLBACK, 200);
  if ('geolocation' in navigator) {
    navigator.geolocation.watchPosition(pos=>{
      const { latitude, longitude, accuracy, speed } = pos.coords;
      const spdEl = document.getElementById('spd'); if (spdEl) spdEl.textContent = (speed||0).toFixed(1);
      showNearestPanorama({lat:latitude,lng:longitude}, 150);
    });
  }
}
(function ready(){ if (window.google?.maps?.importLibrary) bootMaps(); else setTimeout(ready, 30); })();

/***** ã‚«ãƒ¡ãƒ©3çŠ¶æ…‹ãƒˆã‚°ãƒ«ï¼ˆoff / back / frontï¼‰ *****/
const camBtn = document.getElementById("camBtn");
const camEl  = document.getElementById("cam");
const panoEl = document.getElementById("pano");

let camStream = null;
/** 'off' | 'back' | 'front' */
let camMode = 'off';

function stopCamStream(){
  try { camStream && camStream.getTracks().forEach(t=>t.stop()); } catch {}
  camStream = null;
}

function updateCamUI(){
  if (camMode === 'off') {
    camEl.style.display = "none";
    panoEl.style.display = "block";
    camBtn.textContent = "ğŸ“· å¤–ã‚«ãƒ¡ãƒ©";
    setStatus("Street View");    // â† ã“ã“
  } else if (camMode === 'back') {
    camEl.style.display = "block";
    panoEl.style.display = "none";
    camBtn.textContent = "ğŸ¤³ å†…ã‚«ãƒ¡ãƒ©";
    setStatus("ã‚«ãƒ¡ãƒ©ï¼ˆå¤–ï¼‰");
  } else {
    camEl.style.display = "block";
    panoEl.style.display = "none";
    camBtn.textContent = "ğŸ—ºï¸ OFFï¼ˆSVï¼‰";
    setStatus("ã‚«ãƒ¡ãƒ©ï¼ˆå†…ï¼‰");
  }
}

async function switchTo(nextMode){
  // æ—¢å­˜ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢
  stopCamStream();

  if (nextMode === 'off') {
    camMode = 'off';
    camEl.style.display = "none";
    panoEl.style.display = "block";
    updateCamUI();
    // â˜… è¿½åŠ ï¼šSVã‚’ç¢ºå®Ÿã«å†æç”»ï¼ˆãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã§ï¼‰
    reflowStreetView(true);
    return;
  }

  const want = nextMode === 'back' ? "environment" : "user";
  const exact = { exact: want };
  const getWith = (fm) => navigator.mediaDevices.getUserMedia({
    video: { facingMode: fm, width:{ideal:1280}, height:{ideal:720} },
    audio: false
  });

  try {
    try { camStream = await getWith(exact); }
    catch { camStream = await getWith(want); }

    const vtrack = camStream.getVideoTracks()[0];
    if (!vtrack) throw new Error("no video track");

    camMode = nextMode;

    // â˜… å…ˆã«è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ â†’ srcObject â†’ play() ã®é †ï¼ˆé»’å¯¾ç­–ï¼‰
    panoEl.style.display = "none";
    camEl.style.display  = "block";
    camEl.muted = true;
    camEl.setAttribute('playsinline','true');
    camEl.setAttribute('webkit-playsinline','true');

    camEl.srcObject = camStream;

    try {
      await camEl.play();
    } catch {
      await new Promise(r => camEl.addEventListener('loadedmetadata', r, {once:true}));
      try { await camEl.play(); } catch {}
    }

    updateCamUI();

    // ä¿é™ºï¼š500mså¾Œã«ã¾ã çœŸã£é»’ãªã‚‰ã‚‚ã†ä¸€åº¦ play
    setTimeout(()=>{
      if (camMode!=='off' && camEl.videoWidth === 0) {
        camEl.play().catch(()=>{});
      }
    }, 500);

  } catch (e) {
    setStatus("ã‚«ãƒ¡ãƒ©é–‹å§‹ã§ãã¾ã›ã‚“: " + (e?.name || "") + " " + (e?.message || e));
    camMode = 'off';
    camEl.style.display = "none";
    panoEl.style.display = "block";
    updateCamUI();
  }
}

function reflowStreetView(hard = false) {
  if (!window.pano) return;
  // è¡¨ç¤ºçŠ¶æ…‹ã‚’ä¿è¨¼
  panoEl.style.display = 'block';
  try {
    // å¯è¦–åŒ–+ãƒªã‚µã‚¤ã‚ºé€šçŸ¥ã§å†æç”»ã‚’ä¿ƒã™
    window.pano.setVisible(true);
    google.maps.event.trigger(window.pano, 'resize');

    // POVã‚’ã‚»ãƒƒãƒˆã—ç›´ã—ã¦ã‚‚ã†ä¸€æŠ¼ã—
    const pov = window.pano.getPov && window.pano.getPov();
    if (pov) window.pano.setPov({ heading: pov.heading, pitch: pov.pitch });

    // ãã‚Œã§ã‚‚æ€ªã—ã„ç«¯æœ«å‘ã‘ï¼šåŒã˜panoIdã‚’å†ã‚»ãƒƒãƒˆï¼ˆãƒãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼‰
    if (hard) {
      const id = window.pano.getPano && window.pano.getPano();
      if (id) window.pano.setPano(id);
    }

    // ãƒ¬ãƒ¼ã‚¹å¯¾ç­–ã§ã‚¿ã‚¤ãƒãƒ¼ã§ã‚‚ã†ä¸€åº¦
    setTimeout(() => {
      google.maps.event.trigger(window.pano, 'resize');
    }, 50);
  } catch {}
}

// åˆæœŸè¡¨ç¤º
updateCamUI();

// ã‚¯ãƒªãƒƒã‚¯ã”ã¨ã«çŠ¶æ…‹ã‚’å›ã™
camBtn.addEventListener("click", async ()=>{
  if (camMode === 'off') {
    await switchTo('back');   // OFF â†’ å¤–
  } else if (camMode === 'back') {
    await switchTo('front');  // å¤– â†’ å†…
  } else {
    await switchTo('off');    // å†… â†’ OFF
  }
});

// ãƒšãƒ¼ã‚¸é›¢è„±ã§åœæ­¢ï¼ˆæ—¢å­˜ã® pagehide ãƒãƒ³ãƒ‰ãƒ©ãŒã‚ã‚Œã°ä½µå­˜OKï¼‰
window.addEventListener('pagehide', stopCamStream);
// â˜… ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°æ™‚ã®é»’å¯¾ç­–
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && camMode !== 'off' && camEl.srcObject) {
    camEl.play().catch(()=>{});
  }
});

/***** ãƒ‡ãƒã‚¤ã‚¹æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã§ Street View ã‚’å›ã™ *****/
if (window.DeviceOrientationEvent) {
  window.addEventListener("deviceorientationabsolute", handleOrientation, true);
  window.addEventListener("deviceorientation", handleOrientation, true);
}

function handleOrientation(event) {
  if (!window.pano) return;

  let heading = null;

  if (typeof event.webkitCompassHeading !== "undefined") {
    // iOS (Safari) ç”¨
    heading = event.webkitCompassHeading;
  } else if (event.alpha !== null) {
    // Android Chrome ç­‰
    heading = 360 - event.alpha; // alphaã¯æ™‚è¨ˆå›ã‚Šã€Street Viewã¯é€†å‘ã
  }

  if (heading !== null) {
    window.pano.setPov({
      heading: heading,
      pitch: 0
    });
    // HUDã«è¡¨ç¤º
    const hdgEl = document.getElementById("hdg");
    if (hdgEl) hdgEl.textContent = heading.toFixed(0);
  }
}

let gyroEnabled = false;
async function enableOrientationTracking() {
  // iOSï¼ˆSafariï¼‰: requestPermission ãŒå¿…è¦
  if (typeof DeviceOrientationEvent !== "undefined" &&
      typeof DeviceOrientationEvent.requestPermission === "function") {
    try {
      const state = await DeviceOrientationEvent.requestPermission(); // â† ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œç›´å¾Œã«ã—ã‹å‘¼ã¹ã¾ã›ã‚“
      if (state !== "granted") { setStatus("æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ"); return; }
    } catch (e) {
      setStatus("æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯è¦æ±‚ã«å¤±æ•—"); return;
    }
  }
  // è¨±å¯å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ï¼ˆiOS/Androidä¸¡å¯¾å¿œï¼‰
  window.addEventListener("deviceorientationabsolute", handleOrientation, true);
  window.addEventListener("deviceorientation", handleOrientation, true);
  gyroEnabled = true;
  setStatus("æ–¹è§’è¿½å¾“ã‚’é–‹å§‹");
  document.getElementById("gyroBtn").textContent = "ğŸ§­ æ–¹è§’è¿½å¾“ONï¼ˆç¨¼åƒä¸­ï¼‰";
}

// æ—¢å­˜ã® micBtn ã® click ã«ã¶ã‚‰ä¸‹ã’ã¦ã‚‚OKï¼ˆæœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’æ´»ç”¨ï¼‰
document.getElementById("gyroBtn").addEventListener("click", () => {
  if (!gyroEnabled) enableOrientationTracking();
});

/***** foolã‚’ã‚¿ãƒƒãƒ—ã§éè¡¨ç¤ºãƒ»è¡¨ç¤º *****/
let forceStopVisible = false; 

const uiButtons = [
  document.getElementById('gyroBtn'), // ãªã„å ´åˆã‚‚ã‚ã‚‹ã®ã§å¾Œã§nullãƒã‚§ãƒƒã‚¯
  document.getElementById('stopBtn'),
  document.getElementById('camBtn'),
  document.querySelector('.hud'),
];

let uiHidden = false;
function setUIHidden(next) {
  uiHidden = next;
  uiButtons.forEach(el => {
    if (!el) return;
    // â˜… recãŒéŒ²éŸ³ä¸­ã€ã¾ãŸã¯å¼·åˆ¶è¡¨ç¤ºãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹å ´åˆã¯ stopBtn ã‚’éš ã•ãªã„
    if (el === stopBtn && (forceStopVisible || (rec && rec.state === 'recording'))) {
      el.classList.remove('hidden');
      el.style.display = 'block';
      return;
    }
    el.classList.toggle('hidden', uiHidden);
  });
}
/***** Step3ï¼šMediaRecorder éŒ²éŸ³ â†’ STT â†’ ä¼šè©±API *****/
let stream=null, rec=null, chunks=[], stopLevel=null;
const stopBtn= document.getElementById('stopBtn');

function pickAudioMime(){
  const c=["audio/webm;codecs=opus","audio/webm","audio/mp4;codecs=mp4a.40.2","audio/mp4"]; 
  if(!window.MediaRecorder?.isTypeSupported) return ""; 
  for (const t of c) if (MediaRecorder.isTypeSupported(t)) return t; 
  return ""; }

// å…¥åŠ›ãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼
function startLevelMeter(stream){
  const AC = window.AudioContext || window.webkitAudioContext; const ac = new AC();
  const src = ac.createMediaStreamSource(stream); const an = ac.createAnalyser(); an.fftSize=1024; src.connect(an);
  const data = new Uint8Array(an.frequencyBinCount); const bar = document.getElementById('levelBar'); let raf=0;
  (function tick(){ an.getByteTimeDomainData(data); let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
    const rms = Math.sqrt(sum/data.length); bar.style.width = Math.min(100, Math.round(rms*180)) + "%"; raf=requestAnimationFrame(tick); })();
  return ()=>{ cancelAnimationFrame(raf); ac.close(); };
}

async function preflightMic(){
  const s = await navigator.mediaDevices.getUserMedia({ audio:true }); s.getTracks().forEach(t=>t.stop());
}

async function sendToSTT(blob){
  const res = await fetch(STT_URL, { method:'POST', headers:{ 'Content-Type': blob.type || 'application/octet-stream' }, body: await blob.arrayBuffer() });
  if (!res.ok) throw new Error('STT HTTP '+res.status); const j = await res.json().catch(()=>({text:''})); return j.text || j.result || '';
}

async function askChat(text){
  try{
    const res = await fetch(CHAT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
      model:"gpt-4o-mini", stream:true,
      messages:[ {role:"system", content:"ã‚ãªãŸã¯å…ƒæ°—ãªå°‘å¹´ã‚­ãƒ£ãƒ©ã€Foolã€ã§ã™ã€‚çŸ­ã„æ—¥æœ¬èªã‚»ãƒªãƒ•ã§è¿”ç­”ã€‚æ•¬ç§°ä¸è¦ã€‚çµµæ–‡å­—ã¯æ§ãˆã‚ã€‚"}, {role:"user", content:text} ]
    }) });
    if (!res.ok || !res.body){ setStatus("æ¥ç¶šã‚¨ãƒ©ãƒ¼("+res.status+")"); return; }

    clearReply(); // â† ãƒ†ãƒ­ãƒƒãƒ—ã‚’ç©ºã«ã—ã¦ã‹ã‚‰
    const reader = res.body.getReader(); const dec = new TextDecoder(); let buf="";
    for(;;){
      const {value,done} = await reader.read(); if(done) break;
      buf += dec.decode(value,{stream:true});
      let nl;
      while((nl = buf.indexOf("\n"))>=0){
        const line = buf.slice(0,nl).trim(); buf = buf.slice(nl+1);
        if(!line.startsWith("data:")) continue;
        const payload=line.slice(5).trim(); if(payload==="[DONE]") {buf=""; break;}
        try{
          const j = JSON.parse(payload);
          const delta = j?.choices?.[0]?.delta?.content || "";
          if(delta) appendReplyChunk(delta); // â† ä¼šè©±æœ¬æ–‡ã¯ãƒ†ãƒ­ãƒƒãƒ—ã ã‘ã«æµã™
        }catch{}
      }
    }
  }catch(e){
    setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼: "+(e?.message||e)); // â† ã‚¨ãƒ©ãƒ¼ã¯HUDã ã‘
  }
}

async function startRecording(){
  if (!isSecureContext) { setStatus('HTTPSã§é–‹ã„ã¦ãã ã•ã„'); return; }
  if (!navigator.mediaDevices?.getUserMedia) { setStatus('getUserMediaæœªå¯¾å¿œ'); return; }

  setStatus('æ¨©é™å–å¾—ä¸­â€¦');
  try{ await preflightMic(); }catch(e){ setStatus('æ¨©é™å–å¾—å¤±æ•—'); return; }

  setStatus('éŒ²éŸ³åˆæœŸåŒ–â€¦');
  try{ stream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, channelCount:1 } }); }
  catch(e){ setStatus('éŒ²éŸ³ç”¨ã‚¹ãƒˆãƒªãƒ¼ãƒ å¤±æ•—'); return; }

  try{ stopLevel = startLevelMeter(stream); }catch{}

  const mime = pickAudioMime();
  try{ rec = mime ? new MediaRecorder(stream,{mimeType:mime}) : new MediaRecorder(stream); }
  catch(e){ setStatus('MediaRecorderä½œæˆå¤±æ•—'); return; }

  chunks=[];
  rec.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
  rec.onstart = ()=>{ setStatus('éŒ²éŸ³ä¸­â€¦è©±ã—ã‹ã‘ã¦ã­'); stopBtn.disabled = false; };
  rec.onstop = async ()=>{
    stopBtn.disabled = true;
  
    try { stopLevel && stopLevel(); } catch {}
    try { stream.getTracks().forEach(t=>t.stop()); } catch {}
  
    // ï¼ˆä»»æ„ï¼‰æœ€å¾Œã® dataavailable ã‚’å–ã‚Šã“ã¼ã•ãªã„ä¿é™º
    // await new Promise(r => setTimeout(r, 0));
  
    const type = rec.mimeType || (chunks[0] && chunks[0].type) || 'audio/webm';
    const blob = new Blob(chunks, { type });
  
    try {
      setStatus('STTé€ä¿¡ä¸­â€¦');
      let text = '';
      try {
        text = await sendToSTT(blob);
      } catch(e) {
        setStatus('STTå¤±æ•—');
        return;
      }
      if (!text) {
        setStatus('ï¼ˆèãå–ã‚Œãªã‹ã£ãŸã‹ã‚‚ï¼‰');
        return;
      }
  
      // ä¼šè©±ã¯ãƒ†ãƒ­ãƒƒãƒ—ã ã‘ã«
      showReplyThinking();
      await askChat(text);
  
    } finally {
      // â† æˆå¦ã«é–¢ã‚ã‚‰ãšå¿…ãšå¾Œç‰‡ä»˜ã‘
      forceStopVisible = false;
      if (uiHidden) stopBtn.classList.add('hidden');
      stopBtn.style.display = 'none';
    }
  };
  try{ rec.start(2000); }catch(e){ setStatus('rec.startå¤±æ•—'); }
}

stopBtn.addEventListener('click', ()=>{
  try{ rec && rec.stop(); }catch{}
  forceStopVisible = false;                 // â˜…è¿½åŠ 
  if (uiHidden) stopBtn.classList.add('hidden'); // â˜…è¿½åŠ 
  stopBtn.style.display = "none";
});


/***** ä¾¿åˆ©ï¼šãƒšãƒ¼ã‚¸é›¢è„±ã§åœæ­¢ *****/
window.addEventListener('pagehide', ()=>{ try{ rec && rec.stop(); }catch{} try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch{} });
</script>

<!-- â˜…YOUR_API_KEY ã‚’ã‚ãªãŸã®ã‚­ãƒ¼ã«ç½®ãæ›ãˆ -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQQHZONAJ27HZwG20IJbRYZXZ6ADxbtP0&v=weekly"></script>
</body>
</html>