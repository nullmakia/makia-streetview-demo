<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Street View Ã— GPS Ã— ã‚­ãƒ£ãƒ©åå¿œ</title>

<style>
  html, body, #pano { height: 100%; margin: 0; background: #000; }
  #pano {
    position: fixed;
    inset: 0;
    z-index: 0;            /* èƒŒæ™¯ã¨ã—ã¦æœ€èƒŒé¢ã«å›ºå®š */
  }
  /* â€”â€” ã‚­ãƒ£ãƒ©ï¼ˆå‰æ™¯ï¼‰ â€”â€” */
  .sprite {
    position: fixed;
    z-index: 2000;         /* ãƒ‘ãƒãƒ©ãƒã‚ˆã‚Šååˆ†æ‰‹å‰ã« */
    pointer-events: auto;
    touch-action: manipulation;
    image-rendering: auto;
    filter: drop-shadow(0 8px 14px rgba(0,0,0,.35));
    will-change: transform;
    user-select: none;
  }
  /* å°‘å¹´ï¼ˆå·¦å¯„ã‚Šãƒ»ä¸‹ï¼‰ */
  .boy {
    left: 12vw; bottom: 10vh;
    width: min(40vw, 320px);
    aspect-ratio: 5/6;
    background: url('fool1.png') center / contain no-repeat;
  }
  /* â†“ å°‘å¹´ã®å³æ¨ªã«å¯„ã›ã‚‹ï¼šå°‘å¹´ã®å·¦ä½ç½® + å°‘å¹´ã®å¹… + éš™é–“(6vw) */
  .dog {
    /* å°‘å¹´ left(12vw) + å°‘å¹´å¹… + éš™é–“(3vw) â†’ ã•ã‚‰ã«å·¦å¯„ã› */
    left: calc(6vw + min(20vw, 100px) + 15vw);
    bottom: 11vh;
    width: min(15vw, 200px);
    aspect-ratio: 5/6;
    background: url('fool2.png') center / contain no-repeat;
  }

  /* å½±ï¼ˆç°¡æ˜“ï¼‰ */
  .shadow { z-index: 1500; } /* å½±ã¯ã‚­ãƒ£ãƒ©ã‚ˆã‚ŠèƒŒé¢ã ãŒãƒ‘ãƒãƒ©ãƒã‚ˆã‚Šå‰ */

  /* åå¿œã‚¢ãƒ‹ãƒ¡ï¼ˆå°‘å¹´ï¼šã´ã‚‡ã‚“ï¼‹æ‰‹ã‚’æŒ¯ã‚‹é¢¨ã®æºã‚Œï¼‰ */
  @keyframes boyJump {
    0%   { transform: translateY(0) rotate(0deg) }
    20%  { transform: translateY(-14px) rotate(-2deg) }
    40%  { transform: translateY(-22px) rotate(2deg) }
    60%  { transform: translateY(-10px) rotate(-1deg) }
    100% { transform: translateY(0) rotate(0deg) }
  }
  .boy.react { animation: boyJump .7s ease-out; }

  /* åå¿œã‚¢ãƒ‹ãƒ¡ï¼ˆçŠ¬ï¼šé¦–ã¶ã‚“ã¶ã‚“ï¼‹å°ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰ */
  @keyframes dogShake {
    0% { transform: translateY(0) rotate(0deg) }
    15% { transform: translateY(-6px) rotate(-6deg) }
    30% { transform: translateY(-6px) rotate(6deg) }
    45% { transform: translateY(-6px) rotate(-6deg) }
    60% { transform: translateY(-2px) rotate(4deg) }
    100%{ transform: translateY(0) rotate(0deg) }
  }
  .dog.react { animation: dogShake .6s ease-out; }

  /* ã‚»ãƒªãƒ•ãµãã ã— */
  .bubble {
    position: absolute; left: 50%; bottom: 100%;
    transform: translateX(-50%);
    white-space: nowrap;
    background: rgba(255,255,255,.95);
    color: #222; font: 600 14px/1.2 system-ui, -apple-system, "Segoe UI", sans-serif;
    padding: 8px 10px; border-radius: 14px;
    border: 1px solid rgba(0,0,0,.15);
    box-shadow: 0 6px 12px rgba(0,0,0,.18);
    opacity: 0; animation: pop .75s ease forwards;
    z-index: 20;
  }
  @keyframes pop {
    0% { transform: translate(-50%, 6px) scale(.9); opacity: 0; }
    40%{ transform: translate(-50%, 0)   scale(1);   opacity: 1; }
    90%{ opacity: 1; }
    100%{ opacity: 0; }
  }

  /* æ—¢å­˜ã® .hud ã« position ã‚’ä»˜ã‘ã¦æœ€å‰é¢ã«å›ºå®š */
  .hud {
    position: fixed;
    top: 12px;
    left: 12px;
    z-index: 3000;
  }
  .hud button { padding: 6px 8px; border: 0; border-radius: 8px; }
  /* === ãƒ†ãƒ­ãƒƒãƒ—ã¨ãƒã‚¤ã‚¯é–‹å§‹ãƒœã‚¿ãƒ³ === */
  #aiTelopBox{
    position:fixed; left:12px; right:12px; bottom:12px;
    padding:10px 12px; background:rgba(255,255,255,.92);
    border:1px solid #e5e5e5; border-radius:12px; backdrop-filter:blur(4px);
    box-shadow:0 4px 18px rgba(0,0,0,.12); z-index:4000; font-size:14px;
  }
  #aiTelopBox .label{ font-weight:700; margin-right:6px; }
  #micStart{
    position:fixed; right:12px; bottom:80px; z-index:4001;
    padding:10px 12px; border:1px solid #111; background:#111; color:#fff; border-radius:10px;
  }
  /* === å¹ãå‡ºã—ï¼ˆFool ã®è¿”ç­”ï¼‰=== */
  #foolBalloon {
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: 12px;
    max-width: 92vw;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    padding: 10px 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,.14);
    font-size: 14px;
    line-height: 1.5;
    z-index: 4000;
  }
  #foolBalloon .name {
    display: inline-block; font-weight: 700; margin-right: 6px;
    background: #111; color: #fff; padding: 2px 8px; border-radius: 999px; font-size: 12px;
  }
  #foolBalloon:after {
    content: ""; position: absolute; left: 20px; bottom: -8px;
    border-width: 8px 8px 0 8px; border-style: solid;
    border-color: #fff transparent transparent transparent;
    filter: drop-shadow(0 -1px 0 rgba(0,0,0,.08));
  }
</style>

<body>
  <div id="pano" aria-label="Street View èƒŒæ™¯"></div>

  <!-- å‰æ™¯ã‚­ãƒ£ãƒ© -->
  <div class="sprite boy" id="boy"></div>
  <div class="sprite dog" id="dog"></div>
  <div class="shadow" aria-hidden="true"></div>

  <!-- çŠ¶æ…‹è¡¨ç¤º / iOSãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è¨±å¯ -->
  <div class="hud">
    <div>çŠ¶æ…‹: <span id="st">åˆæœŸåŒ–ä¸­â€¦</span></div>
    <div>é€Ÿåº¦: <span id="spd">0.0</span> m/sã€€æ–¹ä½: <span id="hdg">â€”</span>Â°</div>
  </div>
  <!-- ç”»é¢ã«ãƒˆã‚°ãƒ«ã¨ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->
  <button id="btnGyro" style="position:fixed;right:8px;bottom:64px;z-index:1000;">ğŸ¯ ã‚¸ãƒ£ã‚¤ãƒ­OFF</button>
  <button id="btnCal"  style="position:fixed;right:8px;bottom:28px;z-index:1000;">â†» æ–¹å‘æ ¡æ­£</button>
  <div id="foolBalloon"><span class="name">Fool</span><span id="aiTelop">æº–å‚™ä¸­â€¦</span></div>
  <!-- è¿½åŠ ï¼šæœ€åˆã«è¡¨ç¤ºã™ã‚‹ã€Œãƒã‚¤ã‚¯é–‹å§‹ã€ãƒœã‚¿ãƒ³ -->
  <button id="micStart" aria-label="ãƒã‚¤ã‚¯ã‚’é–‹å§‹">ğŸ¤ ãƒã‚¤ã‚¯ã‚’é–‹å§‹</button>
<script>
// æ—¢å­˜ã®å¤‰æ•°ã«è¿½åŠ 
let gyroMode = false;           // ã‚¸ãƒ£ã‚¤ãƒ­ã§è¦–ç·šã‚’åˆ¶å¾¡ã™ã‚‹ã‹
let headingOffset = 0;          // æ ¡æ­£ç”¨ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆåº¦ï¼‰
let smoothedHeading = null;     // æ—¢å­˜ã®å¹³æ»‘åŒ–æ¸ˆã¿ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°ã‚’å†åˆ©ç”¨
let lastDeviceHeading = null;   // ç«¯æœ«ã‹ã‚‰ã®æœ€æ–°ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°

const toRad = d => d * Math.PI / 180;
const toDeg = r => r * 180 / Math.PI;
const norm360 = a => (a % 360 + 360) % 360;
const shortestDeltaDeg = (a,b) => {
  let d = norm360(b) - norm360(a);
  if (d > 180) d -= 360;
  if (d < -180) d += 360;
  return d;
};
function smoothAngle(prev, next, alpha = 0.25) {
  if (prev == null) return next;
  const delta = shortestDeltaDeg(prev, next);
  return norm360(prev + alpha * delta);
}

// ç«¯æœ«å‘ã â†’ æ–¹ä½ã«å¤‰æ›ï¼ˆiOS/Androidä¸¡å¯¾å¿œï¼‰
function extractCompassHeadingFromEvent(e) {
  // iOS Safari: webkitCompassHeading ãŒã€ŒçœŸåŒ—ã‹ã‚‰æ™‚è¨ˆå›ã‚Šï¼ˆåº¦ï¼‰ã€
  if (typeof e.webkitCompassHeading === 'number' && !isNaN(e.webkitCompassHeading)) {
    return norm360(e.webkitCompassHeading + headingOffset);
  }
  // ãã‚Œä»¥å¤–: alpha ã¯ãƒ‡ãƒã‚¤ã‚¹åº§æ¨™(Zè»¸)ã®å›è»¢ã€‚ç”»é¢ã®å›è»¢ã‚’è£œæ­£ã™ã‚‹
  if (typeof e.alpha === 'number') {
    const so = screen.orientation?.angle || window.orientation || 0; // 0,90,180,270
    // ç«¯æœ«ã‚’ç¸¦æŒã¡å‰æã®ç°¡æ˜“è£œæ­£ï¼ˆå¿…è¦ãªã‚‰å¾®èª¿æ•´å¯ï¼‰
    // ã‚³ãƒ³ãƒ‘ã‚¹çš„ãªåŒ—åŸºæº–ã«åˆã‚ã›ã‚‹ãŸã‚ 360 - alpha
    let heading = 360 - e.alpha;
    // ç”»é¢å›è»¢ã‚’è¶³ã™
    heading = heading + so;
    return norm360(heading + headingOffset);
  }
  return null;
}

// StreetViewã®è¦–ç·šã‚’æ›´æ–°
function setPovHeadingPitch(headingDeg, pitchDeg = null) {
  if (!pano) return;
  const pov = pano.getPov();
  const target = {
    heading: headingDeg != null ? headingDeg : (pov.heading ?? 0),
    pitch:   pitchDeg   != null ? pitchDeg   : (pov.pitch ?? 0),
    zoom:    pov.zoom ?? 1
  };
  // å°ã•ãªæºã‚Œã¯ç„¡è¦–
  const delta = Math.abs(shortestDeltaDeg(pov.heading ?? 0, target.heading));
  if (delta < 5 && (pitchDeg == null || Math.abs((pov.pitch??0)-target.pitch) < 2)) return;
  pano.setPov(target);
}

// DeviceOrientation ãƒãƒ³ãƒ‰ãƒ©
function onDeviceOrientation(e) {
  const h = extractCompassHeadingFromEvent(e);
  if (h == null) return;
  lastDeviceHeading = h;

  // ä½é€Ÿ/åœæ­¢æ™‚ã ã‘ã‚¸ãƒ£ã‚¤ãƒ­ã§è¦–ç·šã‚’åˆ¶å¾¡ï¼ˆé€Ÿåº¦ã¯æ—¢å­˜UI/å¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
  const spdEl = document.getElementById('spd');
  const speed = spdEl ? parseFloat(spdEl.textContent) : 0;

  if (gyroMode && (isNaN(speed) || speed < 2.0)) {
    smoothedHeading = smoothAngle(smoothedHeading, h, 0.25);
    setPovHeadingPitch(smoothedHeading);
    const hdgEl = document.getElementById('hdg');
    if (hdgEl) hdgEl.textContent = smoothedHeading.toFixed(0);
  }
}

// iOS ã®è¨±å¯è¦æ±‚ + ç›£è¦–é–‹å§‹
async function enableDeviceOrientation() {
  const C = window.DeviceOrientationEvent;
  if (!C) return { ok:false, reason:'DeviceOrientationæœªå¯¾å¿œ' };

  try {
    if (typeof C.requestPermission === 'function') {
      const state = await C.requestPermission();
      if (state !== 'granted') return { ok:false, reason:'è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ' };
    }
    window.addEventListener('deviceorientation', onDeviceOrientation, true);
    return { ok:true };
  } catch (e) {
    return { ok:false, reason: e?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼' };
  }
}

// ã‚¸ãƒ£ã‚¤ãƒ­ON/OFFãƒˆã‚°ãƒ«
document.getElementById('btnGyro').addEventListener('click', async () => {
  if (!gyroMode) {
    const { ok, reason } = await enableDeviceOrientation();
    if (!ok) { alert('ã‚¸ãƒ£ã‚¤ãƒ­ã‚’ä½¿ãˆã¾ã›ã‚“: ' + reason); return; }
    gyroMode = true;
    document.getElementById('btnGyro').textContent = 'ğŸ¯ ã‚¸ãƒ£ã‚¤ãƒ­ON';
  } else {
    gyroMode = false;
    document.getElementById('btnGyro').textContent = 'ğŸ¯ ã‚¸ãƒ£ã‚¤ãƒ­OFF';
  }
});

// ç¾åœ¨ã®å‘ãã‚’ã€Œæ­£é¢ã€ã«æ ¡æ­£ï¼ˆç«¯æœ«ã‚’å‘ã‘ãŸæ–¹å‘ã‚’0Â°ã¨ã¿ãªã™ï¼‰
document.getElementById('btnCal').addEventListener('click', () => {
  if (lastDeviceHeading == null) return;
  // ç›´è¿‘ã®ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ­£é¢ã«ã™ã‚‹ãŸã‚ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å†è¨ˆç®—
  headingOffset = norm360((smoothedHeading ?? lastDeviceHeading) - lastDeviceHeading);
});
</script>

<script type="module">
  // ===== Street View èµ·å‹•ï¼ˆimportLibrary æ–¹å¼ï¼‰ =====
  const FALLBACK = { lat: 35.6595, lng: 139.7005 }; // æ¸‹è°·é§…å‘¨è¾ºã‚’ä¿é™ºã¨ã—ã¦
  let lastPanoId = null;

  // æ—¢å­˜ã®ã‚¸ãƒ£ã‚¤ãƒ­ã‚³ãƒ¼ãƒ‰ãŒå‚ç…§ã§ãã‚‹ã‚ˆã†ã« window çµŒç”±ã§å…¬é–‹
  window.pano = null;
  window.sv   = null;

  // è¿‘å‚ãƒ‘ãƒãƒ©ãƒã¸ç§»å‹•ã™ã‚‹å…±é€šé–¢æ•°
  function showNearestPanorama(location, radius = 150, tag = '') {
    window.sv.getPanorama({ location, radius }, (data, status) => {
      if (status === 'OK' && data?.location) {
        const panoId = data.location.pano;
        if (panoId !== lastPanoId) {
          window.pano.setPano(panoId);
          lastPanoId = panoId;
          // è¦–ç·šã¯é€²è¡Œæ–¹å‘ãƒ­ã‚¸ãƒƒã‚¯ã‚„ã‚¸ãƒ£ã‚¤ãƒ­ã§å¾Œã‹ã‚‰ä¸Šæ›¸ãã•ã‚Œã‚‹æƒ³å®š
        }
      } else {
        // è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°å°‘ã—åŠå¾„ã‚’åºƒã’ã¦å†è©¦è¡Œï¼ˆæœ€å¤§400mï¼‰
        if (radius < 400) showNearestPanorama(location, Math.min(400, radius + 100), tag);
      }
    });
  }

  async function boot() {
    // Google Maps ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å‹•çš„èª­ã¿è¾¼ã¿
    await google.maps.importLibrary("maps");
    await google.maps.importLibrary("streetView");

    // Street View æº–å‚™
    window.sv = new google.maps.StreetViewService();
    window.pano = new google.maps.StreetViewPanorama(
      document.getElementById('pano'),
      {
        addressControl: false,
        fullscreenControl: false,
        motionTracking: false,
        disableDefaultUI: true,
        visible: true
      }
    );

    // 1) ã¾ãšå¿…ãšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºï¼ˆé»’ç”»é¢é˜²æ­¢ï¼‰
    showNearestPanorama(FALLBACK, 200, 'init');

    // 2) ä½ç½®æƒ…å ±ãŒå–ã‚ŒãŸã‚‰ãã¡ã‚‰ã¸åˆ‡æ›¿
    const st  = document.getElementById('st');
    if ('geolocation' in navigator) {
      navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, accuracy, speed } = pos.coords;
        const spd = document.getElementById('spd');
        if (spd) spd.textContent = (speed || 0).toFixed(1);
        if (st) st.textContent = `æ¸¬ä½OKï¼ˆÂ±${Math.round(accuracy||0)}mï¼‰`;
        showNearestPanorama({ lat: latitude, lng: longitude }, 150, 'gps');
      }, err => {
        if (st) st.textContent = `æ¸¬ä½ã‚¨ãƒ©ãƒ¼: ${err.message}ï¼ˆfallbackè¡¨ç¤ºã‚’ç¶™ç¶šï¼‰`;
      }, { enableHighAccuracy: true, maximumAge: 1000, timeout: 15000 });
    } else {
      if (st) st.textContent = 'Geolocationæœªå¯¾å¿œï¼ˆfallbackè¡¨ç¤ºï¼‰';
    }
  }

  // google.maps ãŒæ¥ãŸã‚‰èµ·å‹•
  const ready = () => (window.google?.maps?.importLibrary) ? boot() : setTimeout(ready, 30);
  ready();
</script>

<script>
// åå¿œã‚¢ãƒ‹ãƒ¡ & ãµãã ã—
function bounce(el, cls) {
  el.classList.remove(cls); void el.offsetWidth; el.classList.add(cls);
  el.addEventListener('animationend', () => el.classList.remove(cls), { once:true });
}
function bubble(el, text) {
  const b = document.createElement('div');
  b.className = 'bubble'; b.textContent = text; el.appendChild(b);
  setTimeout(() => b.remove(), 800);
}

// ã‚­ãƒ£ãƒ©ã«ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸ï¼ˆã‚¯ãƒªãƒƒã‚¯ & ã‚¿ãƒƒãƒï¼‰
const boy = document.getElementById('boy');
const dog = document.getElementById('dog');

['click','touchend'].forEach(type => {
  boy.addEventListener(type, (e) => {
    if (type === 'touchend') e.preventDefault();
    bounce(boy, 'react'); bubble(boy, 'ã„ã“ã†ï¼');
  }, { passive:false });

  dog.addEventListener(type, (e) => {
    if (type === 'touchend') e.preventDefault();
    bounce(dog, 'react'); bubble(dog, 'ãƒ¯ãƒ³ï¼');
  }, { passive:false });
});
</script>
<script>
/** GitHub Pages ã‹ã‚‰ Cloudflare Worker ã‚’å©ã„ã¦çµæœã‚’è¡¨ç¤ºã™ã‚‹è‡ªå‹•ãƒ†ã‚¹ãƒˆï¼ˆå®‰å…¨åŒ–ï¼‰ */
(() => {
  const WORKER_ENDPOINT = "https://makia-animator.animator.workers.dev/chat";
  const out = document.getElementById("aiResult");
  if (!out) return; // â† ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆã€‚ç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

  (async () => {
    try {
      const res = await fetch(WORKER_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          stream: false,
          messages: [{ role: "user", content: "ç–é€šãƒ†ã‚¹ãƒˆï¼š1è¡Œã§è¿”ç­”ã—ã¦" }]
        }),
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      const text = data?.choices?.[0]?.message?.content ?? JSON.stringify(data);
      out.textContent = text;
    } catch (e) {
      console.error("Worker fetch error", e);
      out.textContent = "APIã‚¨ãƒ©ãƒ¼: " + (e?.message || e);
    }
  })();
})();
</script>
<script>
(() => {
  const WORKER_BASE = "https://makia-animator.animator.workers.dev";
  const CHAT_URL = WORKER_BASE + "/chat";
  const STT_URL  = WORKER_BASE + "/stt";

  // ===== ãƒ†ãƒ­ãƒƒãƒ—ï¼ˆæœ€ä½è¡¨ç¤ºæ™‚é–“ã¤ãï¼‰ =====
  const telop = document.getElementById("aiTelop");
  const setTelop = (t) => { telop.textContent = t };
  const MIN_PREP_MS = 1500;
  let prepStartedAt = 0;
  let everReadyShown = false;

  const setPreparing = (why = "") => {
    prepStartedAt = performance.now();
    if (!everReadyShown) {
      setTelop("æº–å‚™ä¸­â€¦" + (why ? `ï¼ˆ${why}ï¼‰` : ""));
    }
  };
  const setReady = () => {
    const show = () => { setTelop("è©±ã—ã‹ã‘ã¦ã­ï¼"); everReadyShown = true; };
    const rest = MIN_PREP_MS - (performance.now() - prepStartedAt);
    if (rest > 0) setTimeout(show, rest); else show();
  };

  // ====== éŸ³å£°â†’æ–‡å­— & ãƒãƒ£ãƒƒãƒˆ ======
  async function askChat(userText) {
    try {
      const res = await fetch(CHAT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          stream: true,
          messages: [
            { role: "system", content: "ã‚ãªãŸã¯å…ƒæ°—ãªå°‘å¹´ã‚­ãƒ£ãƒ©ã€Foolã€ã§ã™ã€‚çŸ­ã„æ—¥æœ¬èªã‚»ãƒªãƒ•ã§è¿”ç­”ã€‚æ•¬ç§°ã¯ä¸è¦ã€‚çµµæ–‡å­—ã¯æ§ãˆã‚ã€‚" },
            { role: "user", content: userText }
          ]
        })
      });
      if (!res.ok || !res.body) { setTelop("æ¥ç¶šã‚¨ãƒ©ãƒ¼(" + res.status + ")"); return; }

      // é€æ¬¡åæ˜ 
      setTelop("");
      const reader = res.body.getReader();
      const dec = new TextDecoder();
      let buf = "";
      for (;;) {
        const { value, done } = await reader.read();
        if (done) break;
        buf += dec.decode(value, { stream:true });
        let nl;
        while ((nl = buf.indexOf("\n")) >= 0) {
          const line = buf.slice(0, nl).trim(); buf = buf.slice(nl + 1);
          if (!line.startsWith("data:")) continue;
          const payload = line.slice(5).trim();
          if (payload === "[DONE]") { buf = ""; break; }
          try {
            const j = JSON.parse(payload);
            const delta = j?.choices?.[0]?.delta?.content || "";
            if (delta) telop.textContent += delta;
          } catch {}
        }
      }
    } catch (e) {
      setTelop("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + (e?.message || e));
    }
  }

  // ====== éŸ³å£°å…¥åŠ›ï¼ˆè‡ªå‹•é–‹å§‹ï¼‹åˆå›ã‚¿ãƒƒãƒ—ã§å†è©¦è¡Œï¼‰ ======
  let rec = null, stream = null, chunks = [], usingSpeechAPI = false, running = false, lastText = "", askedTap = false;
  let keepAlive = false;   // é–‹å§‹ãƒœã‚¿ãƒ³æŠ¼ä¸‹ä¸­ã¯ trueã€åœæ­¢ã§ false
// === é–‹å§‹/åœæ­¢ãƒœã‚¿ãƒ³åˆ¶å¾¡ï¼ˆç½®æ›ï¼‰ ===
const micBtn = document.getElementById("micStart");

function updateMicUI(isRunning) {
  micBtn.textContent = isRunning ? "â–  åœæ­¢" : "ğŸ¤ ãƒã‚¤ã‚¯ã‚’é–‹å§‹";
}

micBtn.addEventListener("click", () => {
  if (!running) {
    // ã€Œawaitã€ã—ãªã„ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®åŒæœŸãƒã‚§ãƒ¼ãƒ³ã‚’å´©ã•ãªã„
    keepAlive = true;
    telop.textContent = "ãƒã‚¤ã‚¯åˆæœŸåŒ–ä¸­â€¦";
    startListening(true);       // â† await ãªã—
    updateMicUI(true);
  } else {
    keepAlive = false;
    stopListening();
    telop.textContent = "åœæ­¢ä¸­";
    updateMicUI(false);
    everReadyShown = false;
  }
});

function requireUserTapOnce(hint = "ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã€‚å³ä¸‹ã®ğŸ¤ã‚’ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã­") {
  setTelop(hint);
}

function humanReadableMicError(e) {
  const name = e && (e.name || e.code || e.message) || "unknown";
  if (name.includes("NotAllowedError") || name.includes("PermissionDismissedError")) {
    return "ãƒã‚¤ã‚¯ãŒâ€œæ‹’å¦â€ã¾ãŸã¯â€œãƒ–ãƒ­ãƒƒã‚¯â€ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚µã‚¤ãƒˆè¨­å®šã§ã€ãƒã‚¤ã‚¯: è¨±å¯ã€ã«å¤‰æ›´ã—ã¦ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­è¾¼ã—ã¦ãã ã•ã„ã€‚";
  }
  if (name.includes("NotFoundError") || name.includes("DevicesNotFoundError")) {
    return "ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å¤–éƒ¨ãƒã‚¤ã‚¯/ãƒ˜ãƒƒãƒ‰ã‚»ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
  }
  if (name.includes("SecurityError") || !window.isSecureContext) {
    return "HTTPSã§ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ï¼ˆGitHub Pagesã¯OKï¼‰ã€‚http://ã§ã¯å‹•ãã¾ã›ã‚“ã€‚";
  }
  return "ãƒã‚¤ã‚¯ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ" + name + "ï¼‰";
}

function setupSpeechAPI() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return null;

  const r = new SR();
  r.lang = "ja-JP";
  r.interimResults = false;
  r.continuous = true;
  r.maxAlternatives = 1;

  let srReadyTimer = null;

  r.onstart = () => {
    running = true;
    if (!everReadyShown) setPreparing("å¾…æ©Ÿä¸­");
    // onstart ã ã‘ã§ Ready ã«ãªã‚‰ãªã„ç«¯æœ«å‘ã‘ä¿é™º
    srReadyTimer = setTimeout(() => setReady(), 2000);
  };

  const markReady = () => {
    if (srReadyTimer) { clearTimeout(srReadyTimer); srReadyTimer = null; }
    setReady();
  };
  r.onaudiostart = markReady;
  r.onsoundstart = markReady;

  r.onend = () => {
    running = false;
    if (srReadyTimer) { clearTimeout(srReadyTimer); srReadyTimer = null; }
    // åœæ­¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã„ãªã„ãªã‚‰è‡ªå‹•å†é–‹
    if (keepAlive) {
      setTimeout(() => { try { r.start(); } catch {} }, 300);
    }
  };

  r.onerror = (e) => {
    // å…¸å‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãªã—/HTTPSã§ãªã„/è¨±å¯æœªä»˜ä¸
    if (e.error === "not-allowed" || e.error === "service-not-allowed") {
      requireUserTapOnce();
    } else {
      // ä»–ã‚¨ãƒ©ãƒ¼ã¯ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºã®ã¿ï¼ˆå†é–‹ã¯ onend å´ã§æ‹…ä¿ï¼‰
      setTelop("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: " + e.error);
    }
  };

  r.onresult = (ev) => {
    let t = "";
    for (let i = ev.resultIndex; i < ev.results.length; i++) {
      if (ev.results[i].isFinal) t += ev.results[i][0].transcript;
    }
    t = (t || "").trim();
    if (t && t !== lastText) { lastText = t; askChat(t); }
  };

  usingSpeechAPI = true;
  return r;
}


async function startMediaRecorder(userGesture = false) {
  try {
    if (!everReadyShown) setPreparing("ãƒã‚¤ã‚¯åˆæœŸåŒ–ä¸­");
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch (e) {
    setTelop(humanReadableMicError(e));
    // â† ã“ã“ã§ requireUserTapOnce() ã‚’å‘¼ã°ãªã„ï¼
    // ã€Œãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’å†ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€ã¨ä¼ãˆã‚‹ã ã‘ã€‚
    return;
  }

  // æ¨©é™OK â†’ Ready è¡¨ç¤ºï¼ˆmuted ä¿é™ºä»˜ãï¼‰
  const [track] = stream.getAudioTracks();
  if (track) {
    if (track.muted) {
      track.onunmute = () => { setReady(); track.onunmute = null; };
      setTimeout(() => setReady(), 2000);
    } else {
      setReady();
    }
  } else {
    setTimeout(() => setReady(), 2000);
  }

  const mime = pickAudioMime();
  let mrOptions = {};
  if (mime) mrOptions.mimeType = mime;

  let m;
  try {
    m = new MediaRecorder(stream, mrOptions);
  } catch (e) {
    try { m = new MediaRecorder(stream); }
    catch (e2) { setTelop("éŒ²éŸ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼"); return; }
  }

  chunks = [];
  m.onstart = () => setReady();
  m.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
  m.onstop = async () => {
    if (!chunks.length) { if (running) { try { m.start(2000); } catch {} } return; }
    const blob = new Blob(chunks, { type: m.mimeType || (chunks[0] && chunks[0].type) || "" });
    chunks = [];
    try {
      const res = await fetch(STT_URL, {
        method: "POST",
        headers: { "Content-Type": blob.type || "application/octet-stream" },
        body: await blob.arrayBuffer()
      });
      const { text = "" } = await res.json();
      const t = (text || "").trim();
      if (t && t !== lastText) { lastText = t; askChat(t); }
    } catch (e) {
      setTelop("éŸ³å£°é€ä¿¡ã‚¨ãƒ©ãƒ¼");
    }
    if (running) { try { m.start(2000); } catch {} }
  };

  rec = m; running = true;
  try { m.start(2000); } catch {}
}


async function startListening(userGesture = false) {
  if (running) return;

  // ã¾ãš Web Speech API
  rec = setupSpeechAPI();
  if (rec) {
    try {
      rec.start();
      const fallbackTimer = setTimeout(async () => {
        if (!everReadyShown) { await disableSpeechAPIAndFallback("timeout"); }
      }, 2500);
      const clearAll = () => clearTimeout(fallbackTimer);
      rec.onaudiostart = ((orig)=> (ev)=>{ orig?.(ev); clearAll(); }) (rec.onaudiostart);
      rec.onsoundstart = ((orig)=> (ev)=>{ orig?.(ev); clearAll(); }) (rec.onsoundstart);
      return;
    } catch {
      await disableSpeechAPIAndFallback("start-exception");
      return;
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  startMediaRecorder(userGesture); // await ã—ãªã„
}

// ç«¯æœ«ãŒå¯¾å¿œã—ã¦ã„ã‚‹éŸ³å£° MIME ã‚’ä¸Šã‹ã‚‰é †ã«é¸ã¶
function pickAudioMime() {
  const cands = [
    "audio/webm;codecs=opus",
    "audio/webm",
    "audio/mp4;codecs=mp4a.40.2", // iOS Safari å‘ã‘
    "audio/mp4"
  ];
  for (const t of cands) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
      return t;
    }
  }
  // å‹æœªæŒ‡å®šã§ä½œã‚Œã‚‹ç«¯æœ«ç”¨ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ãŠä»»ã›ï¼‰
  return "";
}

function stopListening() {
  running = false;
  try { rec && rec.stop && rec.stop(); } catch {}
  try { stream && stream.getTracks().forEach(t => t.stop()); } catch {}
  stream = null;
}

  // åˆæœŸãƒ†ãƒ­ãƒƒãƒ—ã¯ã€Œã‚¿ãƒƒãƒ—ã§é–‹å§‹ã€ã«
  telop.textContent = "ã‚¿ãƒƒãƒ—ã§é–‹å§‹";

  // ãƒšãƒ¼ã‚¸é›¢è„±ã§åœæ­¢
  window.addEventListener("pagehide", stopListening);
})();
</script>

<!-- â˜…YOUR_API_KEY ã‚’ã‚ãªãŸã®ã‚­ãƒ¼ã«ç½®ãæ›ãˆ -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQQHZONAJ27HZwG20IJbRYZXZ6ADxbtP0&v=weekly"></script>
</body>
</html>
